<!DOCTYPE html>
<html>
<head>
  <title>Hello Table</title>
  <meta charset="utf-8" />
  <style>
    #tooltip {
      color: #222222; 
      background-color: #ffdd00;
      padding: 5px;
      text-decoration:none;
      position:relative;
      display:none;
    }
  </style>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://unpkg.com/japan-map-js@1.0.1/dist/jpmap.min.js"></script>
  <script src="js/global.js"></script>
  <script src="js/vvc.js"></script>
  <script src="js/fvc.js"></script>
  <script src="js/ffiber.js"></script>
  <script src="js/vfiber.js"></script>
  <script src="js/fpesticide.js"></script>
  <script src="js/vpesticide.js"></script>
  <script src="js/uspesticide.js"></script>
  <script src="js/cancer.js"></script>
  <script src="js/jpSweetPepper.js"></script>
  <script>
  // console.log(collector);
  function scale(xMax, xMin, yMax, yMin, yInput) {
    percent = (yInput - yMin) / (yMax - yMin);
    return percent * (xMax - xMin) + xMin;
  }

  function getColorCode(max, target) {
    const c = Math.round(255.0 - scale(0,255,0,max,target)).toString(16).padStart(2, "0");
    return "#FF" + c + c;
  }

  function createDiv(did) {
    return $("<div>", {
      id: did,
      css: {
        "border": "1px solid #729c0b",
        "display": "table"
      }
    });
  }

  function addHead(ele, parent) {
    const theadStyle = "background: #729c0b; color: white; text-align: center; border-bottom: 1px solid #f7f7f7; padding: 10px;";
    var tr = $('<tr>');
    $.each(ele.columns, function(idx, ele) {
      const td = $(`<td style="${theadStyle}">`).text(ele);
      tr.append(td)
    });
    parent.append(tr);
  }

  function addLinks(arr) {
    var divs = "";
    $.each(arr, function(idx, ele) {
      divs += `<div><a href="${ele.url}" target="blank">${ele.name}</a></div>`;
    });
    return divs;
  }

  function isNumTable(data) {
    try {
      return data[0].num !== undefined;
    } catch(err) {
      return false;
    }
  }

  function extraStyle(ele, data) {
    if (isNumTable(data)) {
      const max = Math.max(...data.map(ele => ele.num)); 
      const left = Math.round(ele.num / max * 100);
      const right = left + 1;
      return `background: linear-gradient(to right, #efefef ${left}%, white ${right}%);`;
    } else {
      return undefined;
    }
  }

  function addBody(data, parent) {
    $.each(data, function(idx, ele) {
      const tbodyStyleBarChart = extraStyle(ele, data);

      const tbodyStyle = "border-bottom: 1px solid #f7f7f7; padding: 10px;";
      try {
        $('<tr>').append(
          $(`<td style="${tbodyStyle}">`).html(ele.d.tw),
          $(`<td style="${tbodyStyle}">`).html(ele.d.cn),
          $(`<td style="${tbodyStyle}">`).html(ele.d.en),
          $(`<td style="${tbodyStyle}">`).html(ele.d.ja),
          (tbodyStyleBarChart) ? $(`<td style="${tbodyStyle + tbodyStyleBarChart}">`).html(ele.num): "",
          $(`<td style="${tbodyStyle}">`).html(addLinks(ele.d.plant)),
          $(`<td style="${tbodyStyle}">`).html(addLinks(ele.d.cook)),
          $(`<td style="${tbodyStyle}">`).html(addLinks(ele.d.process))
        ).appendTo(parent);
      } catch (err) {
        $('<tr>').append(
          $(`<td colspan="0" style="${tbodyStyle}">`).text("some missing data in global.js"),
        ).appendTo(parent);
      }
    });
  }

  function createTable(ele) {
    var table = $("<table border=0></table>");
    var thead = $("<thead></thead>");
    var tbody = $("<tbody></tbody>");
    
    addHead(ele, thead);
    addBody(ele.data, tbody);

    table.append(thead);
    table.append(tbody);

    return table;
  }

  function printAllTables() {
    $.each(collector, function(idx, ele) {
      const header = $("<h1>").text(ele.title);
      var div = createDiv(ele.tag).append(createTable(ele));
      const hr = $("<hr>");

      $('#tables').append(header);
      $('#tables').append(div);
      $('#tables').append(hr);
    });
  }

  function drawAllJpMap() {
    $.each(jpmap_collector, function(idx, ele) {
      const max = Math.max(...ele.data.map(o => o.num)); ;
      area = [];
      $.each(ele.data, function(i, d) {
        area.push({
          "code": jp_dict[d.area], 
          "number": d.num,
          "color": getColorCode(max, d.num)
        });
      });

      console.log(area);

      var div = document.createElement('div');
      div.id = ele.tag;
      document.body.appendChild(div);
      drawJpMap(area, ele.tag);
    });
  }

  function drawJpMap(area, id) {
    new jpmap.japanMap(document.getElementById(id), {
      areas: area,
      hoverColor: "#ffdd00",
      movesIslands: true,
      borderLineColor: "#000000", 
      onSelect: function(data){
        alert(data.name);
      },
      onHover: function(data){
        var tt = document.getElementById("tooltip");

        if (data.area.number == 0) {
          tt.innerHTML = (data.name);
        } else {
          tt.innerHTML = (data.name + " 種植噸數: " + data.area.number);
        }

        tt.style = "display:block; position:fixed; overflow:hidden;";
      },
      onHoverOut: function(data) {
        var tt = document.getElementById("tooltip");
        tt.style = "display:none;";
      }
    });
  }

  $(document).ready(function() {
    var tooltipSpan = document.getElementById('tooltip');
    window.onmousemove = function (e) {
      var x = e.clientX, y = e.clientY;
      tooltipSpan.style.top = (y + 16) + 'px';
      tooltipSpan.style.left = (x + 16) + 'px';
    };

    printAllTables();
    drawAllJpMap();
  });
  </script>
</head>
<body>      
  <div id="tables"></div>
  <hr>
  <h2>References:</h2>
  <p><a href="https://www.cfs.gov.hk/english/programme/programme_rafs/programme_rafs_n_01_04_01_fruit_veg_report.html" target="blank">維他命C & 膳食纖維</a></p>
  <p><a href="https://tw.appledaily.com/life/20190126/DGLFCEWAPMKX7DLQLMGZXYEEOA/" target="blank">台灣農藥</a></p>
  <p><a href="https://heho.com.tw/archives/77891" target="blank">美國農藥(中文)</a></p>
  <p><a href="https://draxe.com/health/dirty-dozen/" target="blank">美國農藥(英文)</a></p>
  <span id="tooltip"></span>
</body>
</html>


